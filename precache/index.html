<html>

<head>
	<link rel="manifest" href="mypwa.webmanifest">
	<script type="module">
		import { Workbox } from 'https://storage.googleapis.com/workbox-cdn/releases/4.0.0/workbox-window.prod.mjs';

		async function handleCacheUpdate(cacheName, updatedUrl) {
					// Do something with cacheName and updatedUrl.
					// For example, get the cached content and update
					// the content on the page.
					const cache = await  caches.open(cacheName);
					const updatedResponse = await cache.match(updatedUrl);
					const updatedJson = await updatedResponse.text();
					document.getElementById('slow-output2').innerHTML = JSON.stringify(updatedJson);
		}

		if ('serviceWorker' in navigator) {
			const wb = new Workbox('./sw.js');

			wb.addEventListener('activated', (event) => {
				// `event.isUpdate` will be true if another version of the service
				// worker was controlling the page when this version was registered.
				if (!event.isUpdate) {
					console.log('Service worker activated for the first time!');

					// If your service worker is configured to precache assets, those
					// assets should all be available now.
				}
			});

			const updatesChannel = new BroadcastChannel('api-updates')
			updatesChannel.addEventListener('message', event => {
				console.log('here', event)
				if (event.data.type === 'CACHE_UPDATED') {
					const { cacheName, updatedUrl } = event.data.payload;
					console.log(`A newer version of ${updatedURL} is available!`);

					handleCacheUpdate (cacheName, updatedUrl);
				}
			})

			wb.register();
		}
	</script>
	<script>
		function loadData() {
			console.log("Loaded");

			function status(response) {
				if (response.status >= 200 && response.status < 300) {
					return Promise.resolve(response)
				} else {
					return Promise.reject(new Error(response.statusText))
				}
			}

			function json(response) {
				return response.json()
			}

			/* 			fetch('https://opensky-network.org/api/states/all', { mode: 'cors' , headers: {'Access-Control-Request-Headers':'Date'} })
							.then(status)
							.then(json)
							.then(function (data) {
								console.log('Request succeeded with JSON response', data);
								document.getElementById("output").innerHTML = JSON.stringify(data);
								document.getElementById("time").innerHTML = data['time'];
							}).catch(function (error) {
								console.log('Request failed', error);
								document.getElementById("output").innerHTML = error;
							}); */
			function callApi(url, domIdForResult) {
				fetch(url,
					{
						cache: 'no-cache', // only applies to browser cache
						mode: 'same-origin'
					})
					.then(status)
					.then(json)
					.then(function (data) {
						console.log('Request ' + url + ' succeeded with JSON response', data);
						document.getElementById(domIdForResult).innerHTML = JSON.stringify(data);

					}).catch(function (error) {
						console.log('Request ' + url + ' failed', error);
						document.getElementById(domIdForResult).innerHTML = error;
					});
			}
			callApi('./api/slow/data.json', 'slow-output1');
			callApi('./api/fast/data.json', 'fast-output');

		}

	</script>
</head>

<body onload="loadData()">
	<h1>Demonstration of caching with service worker</h1>

	<span id="slow-output1"></span>
	<span id="slow-output2"></span>
	<span id="fast-output"></span>
</body>

</html>