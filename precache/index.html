<html>

<head>
	<link rel="manifest" href="mypwa.webmanifest">
	<script type="module">
		import { Workbox } from 'https://storage.googleapis.com/workbox-cdn/releases/4.0.0/workbox-window.prod.mjs';

		if ('serviceWorker' in navigator) {
			const wb = new Workbox('./sw.js');

			wb.addEventListener('activated', (event) => {
				// `event.isUpdate` will be true if another version of the service
				// worker was controlling the page when this version was registered.
				if (!event.isUpdate) {
					console.log('Service worker activated for the first time!');

					// If your service worker is configured to precache assets, those
					// assets should all be available now.
				}
			});

			const updatesChannel = new BroadcastChannel('apis-update')
				updatesChannel.addEventListener('message', event => {
				console.log('here', event)  
				if (event.data.type === 'CACHE_UPDATED') {
					const { updatedURL } = event.data.payload;

					console.log(`A newer version of ${updatedURL} is available!`);
				}
			})

			wb.register();
		}
	</script>
	<script>
		function loadData() {
			console.log("Loaded");

			function status(response) {
				if (response.status >= 200 && response.status < 300) {
					return Promise.resolve(response)
				} else {
					return Promise.reject(new Error(response.statusText))
				}
			}

			function json(response) {
				return response.json()
			}

/* 			fetch('https://opensky-network.org/api/states/all', { mode: 'cors' , headers: {'Access-Control-Request-Headers':'Date'} })
				.then(status)
				.then(json)
				.then(function (data) {
					console.log('Request succeeded with JSON response', data);
					document.getElementById("output").innerHTML = JSON.stringify(data);
					document.getElementById("time").innerHTML = data['time'];
				}).catch(function (error) {
					console.log('Request failed', error);
					document.getElementById("output").innerHTML = error;
				}); */

			 			fetch('./api/data1.test', { mode: 'same-origin' })
							.then(status)
							.then(json)
							.then(function (data) {
								console.log('data 1 Request succeeded with JSON response', data);
								document.getElementById("output").innerHTML = JSON.stringify(data);
								document.getElementById("time").innerHTML = data['time'];
							}).catch(function (error) {
								console.log('data 1 Request failed', error);
								document.getElementById("output").innerHTML = error;
							}); 

		}

	</script>
</head>

<body onload="loadData()">
	<h1>Demonstration of preloading files with service worker</h1>
	Flight Data as of <span id="time"></span><br />
	<span id="output"></span>
</body>

</html>